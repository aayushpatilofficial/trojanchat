<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Device - Remote Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsrsasign"></script>
</head>
<body class="bg-white">
  <div class="container py-4">
    <h1>Device Page</h1>
    <p id="info" class="text-muted"></p>
    <div id="results" class="mt-3"></div>
  </div>

<script>
const socket = io();
const DEVICE_ID = 'device-' + Math.floor(Math.random()*10000);
const GROUPS = ['all'];

socket.on('connect', ()=> {
  document.getElementById('info').textContent = 'Connected as ' + DEVICE_ID;
  socket.emit('register', {device_id: DEVICE_ID, groups: GROUPS});
});

const WHITELIST = ['ping','collect_info','show_alert'];

socket.on('command', (data) => {
  console.log('command', data);
  const {command, payload, token} = data;
  if (!WHITELIST.includes(command)) {
    appendResult('Ignored non-whitelisted command: '+command);
    return;
  }

  // demo HS256 verification with shared secret (only for demo)
  try {
    const ok = KJUR.jws.JWS.verifyJWT(token, 'supersecretkey_demo_change', {alg:['HS256']});
    if (!ok) throw new Error('verify false');
  } catch(e) {
    appendResult('Token verify failed: ' + e.message);
    return;
  }

  let resultObj = {};
  if (command === 'ping') resultObj = {status:'ok', ts: Date.now()};
  else if (command === 'collect_info') resultObj = {uptime: Math.floor(performance.now()/1000), mem: 'demo'};
  else if (command === 'show_alert') { alert('ADMIN ALERT'); resultObj = {alerted:true}; }

  socket.emit('command_result', {device_id: DEVICE_ID, command, result: resultObj});
  appendResult('Executed ' + command + ': ' + JSON.stringify(resultObj));
});

function appendResult(text){
  const d = document.createElement('div');
  d.textContent = '['+new Date().toLocaleTimeString()+'] ' + text;
  document.getElementById('results').prepend(d);
}
</script>
</body>
</html>
